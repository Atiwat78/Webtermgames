<?php
// ‚ú® [‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Localhost] ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÜ 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ 
// ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡πÄ‡∏≠‡∏á
echo '<meta http-equiv="refresh" content="20">'; 
echo 'Last Check: ' . date('H:i:s') . ' (Auto Refreshing...)<br><hr>';

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
require_once 'db.php'; 

// ============================================================
// üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GMAIL (‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
// ============================================================
$gmail_user = 'atiwatnty@gmail.com';     
$gmail_pass = 'vedf sgxi herv xzvt'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á (‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏∏‡∏î‡∏°‡∏≤)
$bank_email_sender = 'scbeasynet@scb.co.th'; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gmail Server
$hostname = '{imap.gmail.com:993/imap/ssl}INBOX';
// ‡πÉ‡∏™‡πà @ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Error ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
$inbox = @imap_open($hostname, $gmail_user, $gmail_pass) or die('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Gmail ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' . imap_last_error());

echo "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏à‡∏≤‡∏Å $bank_email_sender ...<br>";

// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô" (UNSEEN) ‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏à‡∏≤‡∏Å "‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£"
$emails = imap_search($inbox, 'UNSEEN FROM "' . $bank_email_sender . '"');

if ($emails) {
    rsort($emails); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ‡πÉ‡∏´‡∏°‡πà -> ‡πÄ‡∏Å‡πà‡∏≤

    foreach ($emails as $email_number) {
        // ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        $message = imap_fetchbody($inbox, $email_number, 1);
        $message = quoted_printable_decode($message); 

        // üîç ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡∏∞‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (Regex)
        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÄ‡∏ä‡πà‡∏ô 99.16
        if (preg_match('/([\d,]+\.\d{2})/', $message, $matches)) {
            $money_in = floatval(str_replace(',', '', $matches[1])); 
            echo " üì© ‡πÄ‡∏à‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏•: <b style='color:green'>$money_in</b> ‡∏ö‡∏≤‡∏ó <br>";

            // üïµÔ∏è‚Äç‚ôÄÔ∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            // ‡∏´‡∏≤‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏¢‡∏≠‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà (amount) ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô pending
            $sql = "SELECT id, user_id, amount FROM pending_topups WHERE amount = ? AND status = 'pending' LIMIT 1";
            $stmt = $conn->prepare($sql);
            $stmt->bind_param("d", $money_in);
            $stmt->execute();
            $result = $stmt->get_result();

            if ($row = $result->fetch_assoc()) {
                $txn_id = $row['id'];
                $user_id = $row['user_id'];
                $coin_to_give = $row['amount']; 

                // 1. ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                $update_user = $conn->prepare("UPDATE users SET points = points + ? WHERE id = ?");
                $update_user->bind_param("di", $coin_to_give, $user_id);
                $update_user->execute();

                // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                $update_txn = $conn->prepare("UPDATE pending_topups SET status = 'success', updated_at = NOW() WHERE id = ?");
                $update_txn->bind_param("i", $txn_id);
                $update_txn->execute();

                echo "  ‚úÖ <b>MATCH!</b> ‡πÄ‡∏ï‡∏¥‡∏° $coin_to_give ‡∏û‡∏≠‡∏¢‡∏ó‡πå ‡πÉ‡∏´‡πâ User ID: $user_id ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ <br>";
            } else {
                echo "  ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î $money_in ‡∏ö‡∏≤‡∏ó <br>";
            }
        }
        echo "<hr>";
        
        // (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ (‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
    }
} else {
    echo "üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà";
}

imap_close($inbox);
?>